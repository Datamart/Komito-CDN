<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="robots" content="noindex,follow" />
    <meta charset="utf-8" />
    <!--
    An iframe analytics handler hosted on a shared domain:
    e.g. https://shared-domain.com/iframe.html?origin=https://example.com
    -->
    <script>
      (() => {
        if (self !== parent) {
          const VISITOR_ID_KEY = "_vid";
          const VISITS_COUNT_KEY = "_vc";

          const actions = {
            HANDSHAKE_ACTION: "handshake",
            GET_VISITOR_ACTION: "getVisitor",
            INCREMENT_VISITS_ACTION: "incrementVisits",
            BLA_BLA_BLA_ACTION: "bla",
            FOO_ACTION: "bar",
          };

          const getCookie = (/** @type {string} */ name) => {
            const result = document.cookie
              .split("; ")
              .find((cookie) => cookie.startsWith(name + "="));
            return (result || "").split("=")[1];
          };

          const setCookie = (
            /** @type {string} */ name,
            /** @type {string} */ value
          ) => {
            const cookie = [
              `${encodeURIComponent(name)}=${encodeURIComponent(value)}`,
              `expires=${new Date(Date.now() + 86400e3 * 365).toUTCString()}`,
              `domain=${document.domain}`,
              "path=/; samesite=none; secure",
            ].join("; ");
            console.debug("[IFRAME] before setCookie:", cookie);
            document.cookie = cookie;
            console.debug("[IFRAME] after setCookie:", document.cookie);
          };

          const getUser = () => {
            const visits = getCookie(VISITS_COUNT_KEY) || 1;
            let userId = getCookie(VISITOR_ID_KEY);
            if (!userId) {
              userId = window.crypto.getRandomValues(new Uint32Array(1))[0];
              setCookie(VISITOR_ID_KEY, userId);
            }
            return { userId, visits };
          };

          window.addEventListener("load", (event) => {
            console.log("[IFRAME] load:event:", event);
            const url = new URL(document.referrer || location.href);
            const origin = document.referrer
              ? url.origin
              : url.searchParams.get("origin");
            if (origin) {
              const action = actions.HANDSHAKE_ACTION;
              const source = window.parent;
              const user = getUser();
              source.postMessage({ user, action, actions }, origin);
            }
          });

          window.addEventListener("message", (event) => {
            console.log("[IFRAME] message:event:", event);
            if (event.data) {
              const action = event.data.action;
              const origin = event.origin;
              const source = event.source;
              const user = getUser();
              if (
                action === actions.HANDSHAKE_ACTION ||
                action === actions.GET_VISITOR_ACTION
              ) {
                source.postMessage({ user, action, actions }, origin);
              } else if (action === actions.INCREMENT_VISITS_ACTION) {
                const visits = +getCookie(VISITS_COUNT_KEY) || 1;
                setCookie(VISITS_COUNT_KEY, 1 + visits);
                source.postMessage({ user, action, actions }, origin);
              }
            }
          });
        }
      })();
    </script>
  </head>
</html>
